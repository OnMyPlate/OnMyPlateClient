"use strict";var app=angular.module("OnMyPlate",["ngRoute"]);app.constant("ServerUrl","http://localhost:3000/").constant("HerokuUrl","http://onmyplate.herokuapp.com/").constant("AmazonS3","https://ompimages.s3.amazonaws.com/"),app.run(["$rootScope","$location","$http","$window","authFactory",function(a,b,c,d,e){a.$on("$routeChangeStart",function(){e.isAuthenticated()&&(c.defaults.headers.common.Authorization="Token token="+d.sessionStorage.getItem("OnMyPlate.user"))})}]),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/home.html"}).when("/about",{templateUrl:"templates/about.html"}).when("/profile/:id",{templateUrl:"templates/profile.html"}).when("/foods/:id",{templateUrl:"templates/food.html"}).when("/add",{templateUrl:"templates/add.html"}).when("/favorites",{templateUrl:"templates/favorites.html"}).when("/login",{templateUrl:"templates/login.html"}).when("/register",{templateUrl:"templates/register.html"}).otherwise({redirectTo:"/"})}]),app.controller("NavbarCtrl",["$scope","$location","authFactory","dataFactory","$q","userFactory",function(a,b,c,d,e,f){var g=[];d.fetchUsers().then(function(b){e.all(f.createUsersArray(b.data.users,g)).then(function(){a.currentUser=f.defineCurrentUser(g)})}),a.isActive=function(a){return a===b.path()},a.logout=function(){c.logout().success(function(){b.path("/login")})},a.isLoggedIn=function(){return c.isAuthenticated()},a.toggleNavbar=function(){$("#collapse").slideToggle(300)}}]),app.controller("SidebarCtrl",["$scope","$location","authFactory",function(a,b){a.isActive=function(a){return a===b.path()}}]),app.controller("UserCtrl",["$http","$scope","HerokuUrl","$location","$window",function(a,b,c,d,e){b.registerUser=function(b){var f={user:b};a.post(c+"users",f).success(function(b){e.sessionStorage.setItem("OnMyPlate.user",b.token),a.defaults.headers.common.Authorization="Token token="+e.sessionStorage.getItem("OnMyPlate.user"),d.path("/home")}).error(function(){d.path("/register")})}}]),app.controller("LoginCtrl",["$scope","$location","authFactory",function(a,b,c){a.isLoginSuccessful=!0,a.login=function(d){c.login(d).success(function(){b.path("/")}).error(function(){b.path("/login"),a.isLoginSuccessful=!1,$("#login-error").slideDown(200)})}}]),app.controller("AddCtrl",["$scope","$http","HerokuUrl","$location","$q","imageFactory","dataFactory","foodFactory","userFactory",function(a,b,c,d,e,f,g,h,i){a.ratingVals=[1,2,3,4,5];var j=[];g.fetchFoods().then(function(b){a.foods=b.data.foods}),function(){var b=h.params;b.name&&(a.food=b,a.post=b.posts[0])}(),a.upsertReview=function(a,b,c){k(c,a,b)};var k=function(f,h,k){var m={food:f};f.id?b.put(c+"foods/"+f.id+".json",m).success(function(b){console.log("food updated!"),e.all(l(h,k,b)).then(function(){g.fetchUsers().then(function(b){e.all(i.createUsersArray(b.data.users,j)).then(function(){a.currentUser=i.defineCurrentUser(j),d.path("/profile/"+a.currentUser.id)})})})}):b.post(c+"foods",m).success(function(b){console.log("food created!"),e.all(l(h,k,b)).then(function(){g.fetchUsers().then(function(b){e.all(i.createUsersArray(b.data.users,j)).then(function(){a.currentUser=i.defineCurrentUser(j),d.path("/profile/"+a.currentUser.id)})})})})},l=function(d,g,h){var i={post:{rating:d.rating,review:d.review,food_id:h.id}};d.id?b.put(c+"foods/"+h.id+"/posts/"+d.id,i).success(function(){console.log("post updated!"),e.all(f.signKey(g,i))}):b.post(c+"foods/"+h.id+"/posts",i).success(function(b){console.log("post created!"),a.addedPostId=b.id,e.all(f.signKey(g,i))})}}]),app.controller("ProfileCtrl",["$http","HerokuUrl","$scope","userFactory","$q","$window","dataFactory","$location","foodFactory",function(a,b,c,d,e,f,g,h,i){var j=[];g.fetchUsers().then(function(a){e.all([d.createUsersArray(a.data.users,j),g.fetchFoods()]).then(function(a){c.currentUser=d.defineCurrentUser(j),c.foods=a[1].data.foods})}),c.getRating=function(a){for(var b=[],c=0;c<a.rating;c++)b.push(c);return b},c.goToEdit=function(a){i.storeFood(a),h.path("/add")},c.removeFood=function(d){a.delete(b+"/foods/"+d.id).success(function(){console.log("food is deleted!"),$("#"+d.id).fadeOut(300,function(){c.foods.splice(c.foods.indexOf(d),1)})})}}]),app.controller("FoodCtrl",["$location","$scope","dataFactory","foodFactory","userFactory","$q","$http","HerokuUrl","imageFactory","authFactory",function(a,b,c,d,e,f,g,h,i,j){var k=[];b.ratingVals=[1,2,3,4,5],c.fetchUsers().then(function(g){f.all(e.createUsersArray(g.data.users,k)).then(function(){b.currentUser=e.defineCurrentUser(k),l(b.posts,b.currentUser),f.all(c.fetchFoods().then(function(c){var e=c.data.foods,f=a.path();b.currentFood=d.findCurrentFood(e,f),b.posts=b.currentFood.posts,d.calcFoodRating(b.posts),b.avgFoodRating=d.ratingsArr}))})});var l=function(a,b){a.forEach(function(a){var c=b.likes.filter(function(a){return a.user_id===b.id}).filter(function(b){return a.id===b.post_id});a.liked=c.length>0?"196baacd.glyphicons-13-heart.png":"4e59b096.glyphicons-20-heart-empty.png"})};b.getRating=function(a){for(var b=[],c=0;c<a.rating;c++)b.push(c);return b},b.slideToggleForm=function(){$("form").slideToggle(400)},b.hideForm=function(){$("form").hide(400)},b.postNewPost=function(a,c,d){var e={post:{rating:a.rating,review:a.review,food_id:d.id}};g.post(h+"foods/"+d.id+"/posts",e).success(function(a){b.posts.push(a),f.all(i.signKey(c,e)).then(function(){console.log("post created!")})})},b.removePost=function(c,d){1===d.posts.length?g.delete(h+"/foods/"+d.id+".json").success(function(){g.delete(h+"/foods/"+d.id+"/posts/"+c.id),a.path("/")}):g.delete(h+"/foods/"+d.id+"/posts/"+c.id).success(function(){$("#"+c.id).fadeOut(300,function(){b.posts.splice(b.posts.indexOf(c),1)}),console.log("post is deleted!")})},b.likePost=function(a){var c={like:{post_id:a.id}},d=b.currentUser.likes.filter(function(a){return a.user_id===b.currentUser.id}).filter(function(b){return a.id===b.post_id});if(0===d.length||"4e59b096.glyphicons-20-heart-empty.png"===a.liked&&d.length>0)g.post(h+"likes.json",c).success(function(a){console.log("you like the post bitch!!!"),b.currentUser.likes.push(a),b.posts.filter(function(b){return b.id===a.post_id})[0].likes+=1,b.posts.filter(function(b){return a.post_id===b.id})[0].liked="196baacd.glyphicons-13-heart.png"});else if("196baacd.glyphicons-13-heart.png"===a.liked){var e=b.currentUser.likes.filter(function(b){return b.post_id===a.id})[0].id,f=b.currentUser.likes.filter(function(b){return b.post_id===a.id})[0];g.delete(h+"likes/"+e+".json").success(function(){console.log("unliked the post bitch!!!"),b.currentUser.likes.splice(b.currentUser.likes.length-1,1),b.posts.filter(function(a){return a.id===f.post_id})[0].likes-=1,b.posts.filter(function(a){return a.id===f.post_id})[0].liked="4e59b096.glyphicons-20-heart-empty.png"})}},b.isLoggedIn=function(){return j.isAuthenticated()}}]),app.controller("HomeCtrl",["dataFactory","$scope","foodFactory","$http","HerokuUrl","authFactory","$q","userFactory",function(a,b,c,d,e,f,g,h){var i=[];a.fetchUsers().then(function(c){g.all(h.createUsersArray(c.data.users,i)).then(function(){b.currentUser=h.defineCurrentUser(i),g.all([a.fetchFoods(),a.fetchBookmarks()]).then(function(a){b.bookmarks=a[1].data.bookmarks,b.foods=a[0].data.foods})})}),b.search={name:"",city:"",state:""},b.filter="name",b.placeholder="Name",b.selectSearch=function(a){b.filter=a,b.placeholder=a.charAt(0).toUpperCase()+a.slice(1)},b.getAvgRating=function(a){var b=a.posts;return c.calcFoodRating(b),c.ratingsArr},b.bookmarkFood=function(a,c,f){var g={bookmark:{bookmarked:!0,user_id:c.id,food_id:a.id}},h=f.filter(function(a){return a.user_id===c.id}).filter(function(b){return b.food_id===a.id});void 0!==h[0]?d.delete(e+"bookmarks/"+h[0].id+".json").success(function(){console.log("food unbookmarked!"),b.bookmarks.splice(b.bookmarks.indexOf(h),1)}):d.post(e+"bookmarks.json",g).success(function(a){console.log("food bookmarked!"),b.bookmarks.push(a)})},b.isBookmarked=function(a,b,c){var d=c.filter(function(a){return a.user_id===b.id}).filter(function(b){return b.food_id===a.id}).filter(function(a){return a.bookmarked===!0});return void 0!==d[0]?d[0].bookmarked:!1},b.isLoggedIn=function(){return f.isAuthenticated()}}]),app.controller("FavoriteCtrl",["dataFactory","$scope","$http","HerokuUrl","foodFactory","$q","userFactory",function(a,b,c,d,e,f,g){var h=[];a.fetchUsers().then(function(c){f.all(g.createUsersArray(c.data.users,h)).then(function(){b.currentUser=g.defineCurrentUser(h),f.all([a.fetchFoods(),a.fetchBookmarks()]).then(function(a){b.bookmarks=a[1].data.bookmarks,b.foods=a[0].data.foods})})}),b.unBookmarkFood=function(a,e,f){var g=f.filter(function(a){return a.user_id===e.id}).filter(function(b){return b.food_id===a.id});c.delete(d+"bookmarks/"+g[0].id+".json").success(function(){console.log("food unbookmarked!"),b.bookmarks.splice(b.bookmarks.indexOf(g),1)})},b.isBookmarked=function(a,b,c){var d=c.filter(function(a){return a.user_id===b.id}).filter(function(b){return b.food_id===a.id}).filter(function(a){return a.bookmarked===!0});return void 0!==d[0]?d[0].bookmarked:!1},b.getAvgRating=function(a){var b=a.posts;return e.calcFoodRating(b),e.ratingsArr}}]),app.factory("authFactory",["$http","$window","HerokuUrl","$location",function(a,b,c,d){var e=function(e){return a.post(c+"login",e).success(function(c){b.sessionStorage.setItem("OnMyPlate.user",c.token),a.defaults.headers.common.Authorization="Token token="+b.sessionStorage.getItem("OnMyPlate.user")}).error(function(){d.path("/login")})},f=function(){return a.get(c+"logout").success(function(){b.sessionStorage.removeItem("OnMyPlate.user")})},g=function(){return!!b.sessionStorage.getItem("OnMyPlate.user")};return{login:e,logout:f,isAuthenticated:g}}]),app.factory("userFactory",["$window",function(a){var b=function(a,b){for(var c=0;c<a.length;c++)b.push(a[c]);return b},c=function(a){for(var b=d(),c=0;c<a.length;c++)if(a[c].token===b)return a[c]},d=function(){return a.sessionStorage.getItem("OnMyPlate.user")};return{createUsersArray:b,defineCurrentUser:c}}]),app.factory("imageFactory",["$http","HerokuUrl","$q","$location","AmazonS3",function(a,b,c,d,e){var f,g=function(d,g){a.get(b+"amazon/sign_key").success(function(a){f=a;var b={food_image:{image_url:e+f.key}};c.all(h(d,f)).then(function(){i(b,g)})})},h=function(b,c){var d=new FormData;d.append("key",c.key),d.append("AWSAccessKeyId",c.access_key),d.append("policy",c.policy),d.append("acl","public-read"),d.append("signature",c.signature),d.append("Content-Type","image/jpeg"),d.append("file",b),a.post(e,d,{transformRequest:angular.identity,headers:{"Content-Type":void 0,Authorization:""}}).success(function(){console.log("eureka!")}).error(function(){console.log("fuck you")})},i=function(c,d){return d.post.food_image?a.put(b+"food_images/"+d.post.food_image.id,c):a.post(b+"food_images",c)};return{signKey:g}}]),app.factory("dataFactory",["$http","HerokuUrl",function(a,b){var c=function(){return a.get(b+"foods.json").success(function(a){return a.foods})},d=function(){return a.get(b+"users.json").success(function(a){return a.users})},e=function(){return a.get(b+"food_images.json").success(function(a){return a.food_images})},f=function(){return a.get(b+"bookmarks.json").success(function(a){return a.bookmarks})};return{fetchFoods:c,fetchUsers:d,fetchImages:e,fetchBookmarks:f}}]),app.factory("foodFactory",["$location",function(){var a={},b=[],c=function(a){return parseInt(a.match(/\d+$/)[0])},d=function(a,b){var d=c(b);return a.filter(function(a){return a.id===d})[0]},e=function(a,b){for(var c=0;c<a.length;c++)if(a[c].name===b.name)return a[c]},f=function(b){angular.copy(b,a)},g=function(a){for(var c=[],d=0,e=0;e<a.length;e++)d+=a[e].rating;for(var f=parseInt(d/a.length),e=0;f>e;e++)c.push(e);angular.copy(c,b)};return{findCurrentFood:d,searchDuplicate:e,storeFood:f,params:a,calcFoodRating:g,ratingsArr:b}}]),app.directive("fileread",function(){return{scope:{fileread:"="},link:function(a,b){b.bind("change",function(b){a.$apply(function(){a.fileread=b.target.files[0]})})}}}),app.directive("typeahead",["$http","$timeout",function(){return{restrict:"EA",scope:{type:"@",model:"=",prompt:"@",name:"@",items:"=",property:"@",value:"@"},templateUrl:"templates/typeahead.html",link:function(a){a.currentIndex=0,a.selected=!0,a.select=function(b){a.model=b,a.selected=!0,a.currentIndex=0},a.isCurrent=function(b){return a.currentIndex===b},a.checkKeys=function(b){40===b.keyCode?(b.preventDefault(),a.currentIndex+1!==a.items.length&&(a.currentIndex+=1)):38===b.keyCode&&(b.preventDefault(),0!==a.currentIndex&&(a.currentIndex-=1))}}}}]),app.filter("ellipsis",[function(){return function(a){return a.slice(0,150)+"..."}}]);