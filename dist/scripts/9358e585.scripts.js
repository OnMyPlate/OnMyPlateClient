"use strict";var app=angular.module("OnMyPlate",["ngRoute"]);app.constant("HerokuUrl","http://onmyplate.herokuapp.com/").constant("AmazonS3","https://ompimages.s3.amazonaws.com/"),app.run(["$rootScope","$location","$http","$window","authFactory","backgroundImageService",function(a,b,c,d,e,f){a.$on("$routeChangeStart",function(){e.isAuthenticated()?(f("removeAll"),c.defaults.headers.common.Authorization="Token token="+d.sessionStorage.getItem("OnMyPlate.user")):"/"===b.path()?(f("removeAll"),b.path("/")):"/register"===b.path()?(f("register"),b.path("/register")):"/about"===b.path()?(f("about"),b.path("/about")):(f("login"),b.path("/login"))})}]),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/home.html"}).when("/about",{templateUrl:"templates/about.html"}).when("/profile/:id",{templateUrl:"templates/profile.html"}).when("/foods/:id",{templateUrl:"templates/food.html"}).when("/profile/:id/add",{templateUrl:"templates/add.html"}).when("/profile/:id/bookmark",{templateUrl:"templates/bookmark.html"}).when("/login",{templateUrl:"templates/login.html"}).when("/register",{templateUrl:"templates/register.html"}).when("/profile/:id/account",{templateUrl:"templates/account.html"}).otherwise({redirectTo:"/"})}]),app.controller("NavbarCtrl",["$scope","$location","authFactory","dataFactory","$q","userFactory",function(a,b,c,d,e,f){f.defineCurrentUser().then(function(b){a.currentUser=b.data.current_user,a.encodedUserId=window.btoa(a.currentUser.id)}),a.logout=function(){c.logout().success(function(){$("body").addClass("bg-login"),b.path("/login")})},a.isLoggedIn=function(){return c.isAuthenticated()},a.toggleNavbar=function(){$("#collapse").stop(!0,!0).slideToggle(300)},a.changeHamburger=function(){$("#hamburger .line:eq(0)").toggleClass("line1"),$("#hamburger .line:eq(1)").toggleClass("line2"),$("#hamburger .line:eq(2)").toggleClass("line3")}}]),app.controller("SidebarCtrl",["$scope","$location","dataFactory","userFactory","$q",function(a,b,c,d){d.defineCurrentUser().then(function(b){a.currentUser=b.data.current_user,a.encodedUserId=window.btoa(a.currentUser.id)}),a.isActive=function(a){return!!b.path().match(a)}}]),app.controller("UserCtrl",["$http","$scope","HerokuUrl","$location","$window","dataFactory","$route","userFactory",function(a,b,c,d,e,f,g,h){b.doesPasswordsMatch=!0,b.nonExist=!0,b.isActed=!1,b.registerUser=function(e){b.isActed=!0,$("#loader").css("width","100%");var g={user:e},i={username:e.username,email:e.email};e.password===e.password_confirmation?h.doesExist(g).success(function(h){var j=h.exist;j?(b.isActed=!1,f.storeData({exist:!0,email:e.email}),d.path("/login")):a.post(c+"email/confirm",i).success(function(e){e.sent&&a.post(c+"users.json",g).success(function(){b.isActed=!1,f.storeData({registered:!0}),d.path("/login")}).error(function(){b.isActed=!1,d.path("/register")})})}):(b.isActed=!1,b.user={},b.doesPasswordsMatch=!1,$("#password-error").slideDown(200),$("#password-error").delay(3e3).slideUp(200),d.path("/register"))}}]),app.controller("LoginCtrl",["$scope","$location","authFactory","dataFactory","$window","userFactory","$http",function(a,b,c,d,e,f,g){a.isLoginSuccessful=!0,a.isConfirmed=!0,a.doesExist=!0,a.registered=!1,a.isActed=!1,d.params.exist&&(a.existingUserEmail=d.params.email,a.doesExist=!1,$("#existing-error").slideDown(200),$("#existing-error").delay(3e3).slideUp(200)),d.params.registered&&(a.registered=!0,$("#registered").slideDown(200),$("#registered").delay(3e3).slideUp(200)),a.login=function(h){a.isActed=!0,$("#loader").css("width","100%"),f.doesExist(h).then(function(f){var i=f.data.exist;i?d.getConfirm(h).then(function(d){d.data.confirmed?c.login(h).success(function(c){a.isActed=!1,e.sessionStorage.setItem("OnMyPlate.user",c.token),g.defaults.headers.common.Authorization="Token token="+e.sessionStorage.getItem("OnMyPlate.user"),b.path("/")}).error(function(){a.isActed=!1,a.params={},a.isLoginSuccessful=!1,$("#login-error").slideDown(200),$("#login-error").delay(3e3).slideUp(200)}):(a.isActed=!1,b.path("/login"),a.isConfirmed=!1,$("#confirmation-error").slideDown(200),$("#confirmation-error").delay(3e3).slideUp(200))}):(a.isActed=!1,a.params={},a.isLoginSuccessful=!1,$("#login-error").slideDown(200),$("#login-error").delay(3e3).slideUp(200))})}}]),app.controller("AddCtrl",["$scope","$http","HerokuUrl","$location","$q","imageFactory","dataFactory","foodFactory","userFactory","$rootScope",function(a,b,c,d,e,f,g,h,i,j){a.ratingVals=[1,2,3,4,5],g.fetchFoods().then(function(b){a.foods=b.data.foods}),a.params=h.params,a.$watch("params",function(b,c){c.name&&(a.food=c,a.post=c.posts[0])}),a.upsertReview=function(a,b){var c=$("input[type=file]")[0].files[0];k(b,a,c).then(function(){console.log("review successfully processed!")})};var k=function(e,f,g){var h={food:e};return e.id?b.put(c+"foods/"+e.id,h).success(function(b){console.log("food updated!"),l(f,g,b).then(function(){i.defineCurrentUser().then(function(b){a.currentUser=b.data.current_user;var c=window.btoa(a.currentUser.id);d.path("/profile/"+c)})})}):b.post(c+"foods",h).success(function(b){console.log("food created!"),l(f,g,b).then(function(){i.defineCurrentUser().then(function(b){a.currentUser=b.data.current_user;var c=window.btoa(a.currentUser.id);d.path("/profile/"+c)})})})},l=function(d,g,h){var i={post:d};return i.post.food_id=h.id,d.id?b.put(c+"posts/"+d.id,i).success(function(){console.log("post updated!"),f.getSignKey().then(function(a){var b=a,c=f.formImageParams(b);e.all([f.postImageToS3(g,b),f.upsertImageToAPI(g,i,c)]).then(function(a){j.imageResponse=a[1]})})}):b.post(c+"posts",i).success(function(b){console.log("post created!"),a.addedPostId=b.id,f.getSignKey().then(function(a){var b=a,c=f.formImageParams(b);e.all([f.postImageToS3(g,b),f.upsertImageToAPI(g,i,c)]).then(function(a){j.imageResponse=a[1]})})})}}]),app.controller("ProfileCtrl",["$http","HerokuUrl","$scope","userFactory","$q","$window","dataFactory","$location","foodFactory","$rootScope",function(a,b,c,d,e,f,g,h,i,j){g.fetchFoods().then(function(a){c.foods=a.data.foods,j.$watch("imageResponse",function(a){a&&(c.foods[c.foods.length-1].posts[0].food_image=a)}),d.defineCurrentUser().then(function(a){c.currentUser=a.data.current_user})}),c.getRating=function(a){for(var b=[],c=0;c<a.rating;c++)b.push(c);return b},c.goToEdit=function(a){i.storeFood(a);var b=window.btoa(a.user_id);h.path("/profile/"+b+"/add")},c.removeFood=function(d){a.delete(b+"foods/"+d.id).success(function(){console.log("food is deleted!"),$("#"+d.id).fadeOut(300,function(){c.foods.splice(c.foods.indexOf(d),1)})})}}]),app.controller("FoodCtrl",["$location","$scope","dataFactory","foodFactory","userFactory","$q","$http","HerokuUrl","imageFactory","authFactory","$rootScope",function(a,b,c,d,e,f,g,h,i,j,k){b.ratingVals=[1,2,3,4,5],c.fetchFoods().then(function(c){var f=c.data.foods,g=a.path();b.currentFood=d.findCurrentFood(f,g),b.posts=b.currentFood.posts,d.calcFoodRating(b.posts),b.avgFoodRating=d.ratingsArr,e.defineCurrentUser().then(function(a){b.currentUser=a.data.current_user,b.userLikes=a.data.likes,l(b.posts,b.currentUser,b.userLikes)}),k.$watch("postImageResponse",function(a){a&&(b.posts[b.posts.length-1].food_image=a)})});var l=function(a,b,c){a.forEach(c?function(a){var d=c.filter(function(a){return a.user_id===b.id}).filter(function(b){return a.id===b.post_id});a.liked=d.length>0?"glyphicons-13-heart.png":"glyphicons-20-heart-empty.png"}:function(a){a.liked="glyphicons-20-heart-empty.png"})};b.getRating=function(a){for(var b=[],c=0;c<a.rating;c++)b.push(c);return b},b.slideToggleForm=function(){$("form").slideToggle(400)},b.hideForm=function(){$("form").hide(400)},b.postNewPost=function(a,c){var d=$("input[type=file]")[0].files[0],e={post:a};e.post.food_id=c.id,g.post(h+"posts",e).success(function(a){b.posts.push(a),console.log("post created!"),i.getSignKey().then(function(a){var b=a,c=i.formImageParams(b);f.all([i.postImageToS3(d,b),i.upsertImageToAPI(d,e,c)]).then(function(a){k.postImageResponse=a[1]})})})},b.removePost=function(c,d){1===d.posts.length?g.delete(h+"/foods/"+d.id+".json").success(function(){a.path("/")}):g.delete(h+"posts/"+c.id).success(function(){$("#"+c.id).fadeOut(300,function(){b.posts.splice(b.posts.indexOf(c),1)}),console.log("post is deleted!")})},b.likePost=function(a,c,d){var e={like:{post_id:a.id,user_id:c.id}};if(d)var f=d.filter(function(a){return a.user_id===c.id}).filter(function(b){return a.id===b.post_id});else var f=[];if(0===f.length||"glyphicons-20-heart-empty.png"===a.liked&&f.length>0)g.post(h+"likes.json",e).success(function(a){console.log("you like the post!!!"),d.push(a),b.posts.filter(function(b){return b.id===a.post_id})[0].likes+=1,b.posts.filter(function(b){return a.post_id===b.id})[0].liked="glyphicons-13-heart.png"});else if("glyphicons-13-heart.png"===a.liked){var i=d.filter(function(b){return b.post_id===a.id})[0].id,j=d.filter(function(b){return b.post_id===a.id})[0];g.delete(h+"likes/"+i+".json").success(function(){console.log("you unliked the post!!!"),d.splice(d.length-1,1),b.posts.filter(function(a){return a.id===j.post_id})[0].likes-=1,b.posts.filter(function(a){return a.id===j.post_id})[0].liked="glyphicons-20-heart-empty.png"})}},b.isLoggedIn=function(){return j.isAuthenticated()}}]),app.controller("HomeCtrl",["dataFactory","$scope","foodFactory","$http","HerokuUrl","authFactory","$q","userFactory",function(a,b,c,d,e,f,g,h){h.defineCurrentUser().then(function(a){b.currentUser=a.data.current_user}),g.all([a.fetchFoods(),a.fetchBookmarks()]).then(function(a){b.bookmarks=a[1].data.bookmarks,b.foods=a[0].data.foods}),b.search={name:"",city:"",state:""},b.filter="name",b.placeholder="Name",b.selectSearch=function(a){b.filter=a,b.placeholder=a.charAt(0).toUpperCase()+a.slice(1)},b.getAvgRating=function(a){return c.calcFoodRating(a.posts),c.ratingsArr},b.bookmarkFood=function(a,c,f){var g={bookmark:{bookmarked:!0,user_id:c.id,food_id:a.id}},h=f.filter(function(a){return a.user_id===c.id}).filter(function(b){return b.food_id===a.id});h[0]?d.delete(e+"bookmarks/"+h[0].id+".json").success(function(){console.log("food unbookmarked!"),b.bookmarks.splice(b.bookmarks.indexOf(h),1)}):d.post(e+"bookmarks.json",g).success(function(a){console.log("food bookmarked!"),b.bookmarks.push(a)})},b.isBookmarked=function(a,b,c){var d=c.filter(function(a){return a.user_id===b.id}).filter(function(b){return b.food_id===a.id}).filter(function(a){return a.bookmarked===!0})[0];return d?d.bookmarked:!1},b.isLoggedIn=function(){return f.isAuthenticated()}}]),app.controller("BookmarkCtrl",["dataFactory","$scope","$http","HerokuUrl","foodFactory","$q","userFactory",function(a,b,c,d,e,f,g){g.defineCurrentUser().then(function(c){b.currentUser=c.data.current_user,f.all([a.fetchFoods(),a.fetchBookmarks()]).then(function(a){b.bookmarks=a[1].data.bookmarks,b.foods=a[0].data.foods})}),b.unBookmarkFood=function(a,e,f){var g=f.filter(function(a){return a.user_id===e.id}).filter(function(b){return b.food_id===a.id});c.delete(d+"bookmarks/"+g[0].id+".json").success(function(){console.log("food unbookmarked!"),b.bookmarks.splice(b.bookmarks.indexOf(g),1)})},b.isBookmarked=function(a,b,c){var d=c.filter(function(a){return a.user_id===b.id}).filter(function(b){return b.food_id===a.id}).filter(function(a){return a.bookmarked===!0})[0];return d?d.bookmarked:!1},b.getAvgRating=function(a){var b=a.posts;return e.calcFoodRating(b),e.ratingsArr}}]),app.controller("AboutCtrl",[function(){$("body").addClass("bg-about")}]),app.controller("AccountCtrl",["dataFactory","userFactory","$scope","$http","HerokuUrl","$location","$window",function(a,b,c,d,e,f,g){b.defineCurrentUser().then(function(a){c.currentUser=a.data.current_user}),c.deleteAccount=function(a){d.delete(e+"users/"+a.id+".json").success(function(){console.log("user account deleted"),g.sessionStorage.removeItem("OnMyPlate.user"),f.path("/register")})}}]),app.factory("authFactory",["$http","$window","HerokuUrl","$location",function(a,b,c){var d=function(b){return a.post(c+"login",b)},e=function(){return a.get(c+"logout").success(function(){b.sessionStorage.removeItem("OnMyPlate.user")})},f=function(){return!!b.sessionStorage.getItem("OnMyPlate.user")},g=function(b){return a.post(c+"admin",b)};return{login:d,logout:e,isAuthenticated:f,isAdmin:g}}]),app.factory("userFactory",["$window","$http","HerokuUrl",function(a,b,c){var d=function(){var a=e();return b.post(c+"current_user",{token:a})},e=function(){return a.sessionStorage.getItem("OnMyPlate.user")},f=function(a){return b.post(c+"does_exist",a)};return{defineCurrentUser:d,doesExist:f}}]),app.factory("imageFactory",["$http","HerokuUrl","$q","$location","AmazonS3","$rootScope",function(a,b,c,d,e){var f=function(){return c(function(c){a.get(b+"amazon/sign_key").success(function(a){c(a)})})},g=function(a){return{food_image:{image_url:e+a.key}}},h=function(b,c){return a.post(e,j(b,c),{transformRequest:angular.identity,headers:{"Content-Type":void 0,Authorization:""}})},i=function(d,e,f){return c(e.post.food_image?function(c,d){a.put(b+"food_images/"+e.post.food_image.id,f).success(function(a){c(a)}).error(function(a){d(a)})}:function(c,d){a.post(b+"food_images",f).success(function(a){c(a)}).error(function(a){d(a)})})},j=function(a,b){var c=new FormData;return c.append("key",b.key),c.append("AWSAccessKeyId",b.access_key),c.append("policy",b.policy),c.append("acl","public-read"),c.append("signature",b.signature),c.append("Content-Type","image/jpeg"),c.append("file",a),c};return{getSignKey:f,postImageToS3:h,upsertImageToAPI:i,formImageParams:g}}]),app.factory("dataFactory",["$http","HerokuUrl",function(a,b){var c={},d=function(){return a.get(b+"foods.json")},e=function(){return a.get(b+"users.json").success(function(a){return a.users})},f=function(){return a.get(b+"food_images.json").success(function(a){return a.food_images})},g=function(){return a.get(b+"bookmarks.json").success(function(a){return a.bookmarks})},h=function(c){return a.post(b+"get_confirm",c).success(function(a){return a})},i=function(a){angular.copy(a,c)};return{fetchFoods:d,fetchUsers:e,fetchImages:f,fetchBookmarks:g,getConfirm:h,storeData:i,params:c}}]),app.factory("foodFactory",["$location",function(){var a={},b=[],c=function(a){return parseInt(a.match(/\d+$/)[0])},d=function(a,b){var d=c(b);return a.filter(function(a){return a.id===d})[0]},e=function(b){angular.copy(b,a)},f=function(a){var c,d,e=[],f=0;for(a.forEach(function(a){f+=a.rating}),d=parseInt(f/a.length),c=0;d>c;c++)e.push(c);angular.copy(e,b)};return{findCurrentFood:d,storeFood:e,params:a,calcFoodRating:f,ratingsArr:b}}]),app.service("backgroundImageService",[function(){return function(a){switch(a){case"about":$("body").removeClass("bg-login"),$("body").removeClass("bg-reg"),$("body").addClass("bg-about");break;case"login":$("body").removeClass("bg-about"),$("body").removeClass("bg-reg"),$("body").addClass("bg-login");break;case"register":$("body").removeClass("bg-login"),$("body").removeClass("bg-about"),$("body").addClass("bg-reg");break;case"removeAll":$("body").removeClass("bg-login"),$("body").removeClass("bg-reg"),$("body").removeClass("bg-about")}}}]),app.directive("addFoodInput",[function(){return{restrict:"EA",scope:{type:"@",model:"=",prompt:"@",name:"@",items:"=",property:"@",value:"@",length:"="},templateUrl:"templates/add-food-input.html"}}]),app.directive("awsUploader",[function(){return{restrict:"EA",scope:{key:"@",policy:"@",accessKey:"@",signature:"@",model:"="},templateUrl:"templates/aws-uploader.html"}}]),app.filter("ellipsis",[function(){return function(a){return a.slice(0,99)+"..."}}]);