"use strict";var app=angular.module("OnMyPlate",["ngRoute"]);app.constant("ServerUrl","http://localhost:3000/"),app.run(["$rootScope","$location","$http","$window","authFactory",function(a,b,c,d,e){a.$on("$routeChangeStart",function(){e.isAuthenticated()&&(c.defaults.headers.common.Authorization="Token token="+d.sessionStorage.getItem("OnMyPlate.user"))})}]),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/home.html"}).when("/about",{templateUrl:"templates/about.html"}).when("/profile/:id",{templateUrl:"templates/profile.html"}).when("/foods/:id",{templateUrl:"templates/food.html"}).when("/add",{templateUrl:"templates/add.html"}).when("/favorites",{templateUrl:"templates/favorites.html"}).when("/login",{templateUrl:"templates/login.html"}).when("/register",{templateUrl:"templates/register.html"}).otherwise({redirectTo:"/"})}]),app.controller("NavbarCtrl",["$scope","$location","authFactory","dataFactory","$q","userFactory",function(a,b,c,d,e,f){var g=[];d.fetchUsers().then(function(b){e.all(f.createUsersArray(b.data.users,g)).then(function(){a.currentUser=f.defineCurrentUser(g)})}),a.isActive=function(a){return a===b.path()},a.logout=function(){c.logout().success(function(){b.path("/login")})},a.isLoggedIn=function(){return c.isAuthenticated()}}]),app.controller("SidebarCtrl",["$scope","$location","authFactory",function(a,b){a.isActive=function(a){return a===b.path()}}]),app.controller("UserCtrl",["$http","$scope","ServerUrl","$location","$window",function(a,b,c,d,e){b.registerUser=function(b){var f={user:b};a.post(c+"users",f).success(function(b){e.sessionStorage.setItem("OnMyPlate.user",b.token),a.defaults.headers.common.Authorization="Token token="+e.sessionStorage.getItem("OnMyPlate.user"),d.path("/home")}).error(function(){d.path("/register")})}}]),app.controller("LoginCtrl",["$scope","$location","authFactory",function(a,b,c){a.login=function(a){c.login(a).success(function(){b.path("/")})}}]),app.controller("AddCtrl",["$scope","$http","ServerUrl","$location","$q","imageFactory","dataFactory","foodFactory","userFactory",function(a,b,c,d,e,f,g,h,i){a.ratingVals=[1,2,3,4,5];var j=[];g.fetchFoods().then(function(b){a.foods=b.data.foods}),function(){var b=h.params;b.name&&(a.food=b,a.post=b.posts[0])}(),a.upsertReview=function(a,b,c){k(c,a,b)};var k=function(f,h,k){var m={food:f};f.id?b.put(c+"foods/"+f.id+".json",m).success(function(b){console.log("food updated!"),e.all(l(h,k,b)).then(function(){g.fetchUsers().then(function(b){e.all(i.createUsersArray(b.data.users,j)).then(function(){a.currentUser=i.defineCurrentUser(j),d.path("/profile/"+a.currentUser.id)})})})}):b.post(c+"foods",m).success(function(b){console.log("food created!"),e.all(l(h,k,b)).then(function(){g.fetchUsers().then(function(b){e.all(i.createUsersArray(b.data.users,j)).then(function(){a.currentUser=i.defineCurrentUser(j),d.path("/profile/"+a.currentUser.id)})})})})},l=function(a,d,g){var h={post:{rating:a.rating,review:a.review,food_id:g.id}};a.id?b.put(c+"foods/"+g.id+"/posts/"+a.id,h).success(function(){console.log("post updated!"),e.all(f.signKey(d,h))}):b.post(c+"foods/"+g.id+"/posts",h).success(function(){console.log("post created!"),e.all(f.signKey(d,h))})}}]),app.controller("ProfileCtrl",["$http","ServerUrl","$scope","userFactory","$q","$window","dataFactory","$location","foodFactory",function(a,b,c,d,e,f,g,h,i){var j=[];g.fetchFoods().then(function(a){c.foods=a.data.foods}),g.fetchUsers().then(function(a){e.all(d.createUsersArray(a.data.users,j)).then(function(){c.currentUser=d.defineCurrentUser(j)})}),c.getRating=function(a){for(var b=[],c=0;c<a.rating;c++)b.push(c);return b},c.goToEdit=function(a){i.storeFood(a),h.path("/add")},c.removeFood=function(c){a.delete(b+"/foods/"+c.id).success(function(){console.log("food is deleted!"),$("#"+c.id).fadeOut(400)})}}]),app.controller("FoodCtrl",["$location","$scope","dataFactory","foodFactory","userFactory","$q","$http","ServerUrl","imageFactory",function(a,b,c,d,e,f,g,h,i){var j=[];b.ratingVals=[1,2,3,4,5],c.fetchFoods().then(function(c){var e=c.data.foods,f=a.path();b.currentFood=d.findCurrentFood(e,f),b.posts=b.currentFood.posts,d.calcFoodRating(b.posts),b.avgFoodRating=d.ratingsArr}),c.fetchUsers().then(function(a){f.all(e.createUsersArray(a.data.users,j)).then(function(){b.currentUser=e.defineCurrentUser(j),b.userLikes=b.currentUser.likes.length})}),b.getRating=function(a){for(var b=[],c=0;c<a.rating;c++)b.push(c);return b},b.slideToggleForm=function(){$("form").slideToggle(400)},b.hideForm=function(){$("form").hide(400)},b.postNewPost=function(a,c,d){var e={post:{rating:a.rating,review:a.review,food_id:d.id}};g.post(h+"foods/"+d.id+"/posts",e).success(function(a){b.currentFood.posts.push(a),f.all(i.signKey(c,e)).then(function(){console.log("post created!")})})},b.removePost=function(a,b){g.delete(h+"/foods/"+b.id+"/posts/"+a.id).success(function(){console.log("post is deleted!"),$("#"+a.id+"a5b6").fadeOut(400)})},b.likePost=function(a){var c={like:{post_id:a.id}},d=b.currentUser.likes.filter(function(a){return a.user_id===b.currentUser.id}).filter(function(b){return a.id===b.post_id});0===d.length&&g.post(h+"likes.json",c).success(function(a){console.log("you like the post bitch!!!"),b.posts.filter(function(b){return b.id===a.post_id})[0].likes+=1})}}]),app.controller("HomeCtrl",["dataFactory","$scope","foodFactory",function(a,b,c){a.fetchFoods().then(function(a){b.foods=a.data.foods}),b.getAvgRating=function(a){var b=a.posts;return c.calcFoodRating(b),c.ratingsArr}}]),app.factory("authFactory",["$http","$window","ServerUrl","$location",function(a,b,c,d){var e=function(e){return a.post(c+"login",e).success(function(c){b.sessionStorage.setItem("OnMyPlate.user",c.token),a.defaults.headers.common.Authorization="Token token="+b.sessionStorage.getItem("OnMyPlate.user")}).error(function(){d.path("/login")})},f=function(){return a.get(c+"logout").success(function(){b.sessionStorage.removeItem("OnMyPlate.user")})},g=function(){return!!b.sessionStorage.getItem("OnMyPlate.user")};return{login:e,logout:f,isAuthenticated:g}}]),app.factory("userFactory",["$window","$http","ServerUrl",function(a){var b=function(a,b){for(var c=0;c<a.length;c++)b.push(a[c]);return b},c=function(a){for(var b=d(),c=0;c<a.length;c++)if(a[c].token===b)return a[c]},d=function(){return a.sessionStorage.getItem("OnMyPlate.user")};return{createUsersArray:b,defineCurrentUser:c}}]),app.factory("imageFactory",["$http","ServerUrl","$q","$location",function(a,b,c){var d,e=function(e,h){return a.get(b+"amazon/sign_key").success(function(a){d=a;var b={food_image:{image_url:"https://ompimages.s3.amazonaws.com/"+d.key}};c.all(g(b,h)).then(function(){f(e,d)})})},f=function(b,c){var d=new FormData;d.append("key",c.key),d.append("AWSAccessKeyId",c.access_key),d.append("policy",c.policy),d.append("acl","public-read"),d.append("signature",c.signature),d.append("Content-Type","image/jpeg"),d.append("file",b),a.post("https://ompimages.s3.amazonaws.com/",d,{transformRequest:angular.identity,headers:{"Content-Type":void 0,Authorization:""}}).success(function(){console.log("eureka!")}).error(function(){console.log("fuck you")})},g=function(c,d){var e=[];e.push(d.post.food_image?a.put(b+"food_images/"+d.post.food_image.id,c):a.post(b+"food_images",c))};return{signKey:e}}]),app.factory("dataFactory",["$http","ServerUrl",function(a,b){var c=function(){return a.get(b+"foods.json").success(function(a){return a.foods})},d=function(){return a.get(b+"users.json").success(function(a){return a.users})};return{fetchFoods:c,fetchUsers:d}}]),app.factory("foodFactory",["$location",function(){var a={},b=[],c=function(a){return parseInt(a.match(/\d+$/)[0])},d=function(a,b){var d=c(b);return a.filter(function(a){return a.id===d})[0]},e=function(a,b){for(var c=0;c<a.length;c++)if(a[c].name===b.name)return a[c]},f=function(b){angular.copy(b,a)},g=function(a){for(var c=[],d=0,e=0;e<a.length;e++)d+=a[e].rating;for(var f=parseInt(d/a.length),e=0;f>e;e++)c.push(e);angular.copy(c,b)};return{findCurrentFood:d,searchDuplicate:e,storeFood:f,params:a,calcFoodRating:g,ratingsArr:b}}]),app.directive("fileread",function(){return{scope:{fileread:"="},link:function(a,b){b.bind("change",function(b){a.$apply(function(){a.fileread=b.target.files[0]})})}}}),app.directive("typeahead",["$http","$timeout",function(){return{restrict:"EA",scope:{type:"@",model:"=",prompt:"@",name:"@",items:"=",property:"@",value:"@"},templateUrl:"templates/typeahead.html",link:function(a){a.currentIndex=0,a.selected=!0,a.select=function(b){a.model=b,a.selected=!0,a.currentIndex=0},a.isCurrent=function(b){return a.currentIndex===b},a.checkKeys=function(b){40===b.keyCode?(b.preventDefault(),a.currentIndex+1!==a.items.length&&(a.currentIndex+=1)):38===b.keyCode&&(b.preventDefault(),0!==a.currentIndex&&(a.currentIndex-=1))}}}}]);