"use strict";var app=angular.module("OnMyPlate",["ngRoute"]);app.constant("ServerUrl","http://localhost:3000/"),app.run(["$rootScope","$location","$http","$window","authFactory",function(a,b,c,d,e){a.$on("$routeChangeStart",function(){e.isAuthenticated()&&(c.defaults.headers.common.Authorization="Token token="+d.sessionStorage.getItem("OnMyPlate.user"))})}]),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/home.html"}).when("/about",{templateUrl:"templates/about.html"}).when("/profile",{templateUrl:"templates/profile.html"}).when("/food/:id",{templateUrl:"templates/food.html"}).when("/add",{templateUrl:"templates/add.html"}).when("/favorites",{templateUrl:"templates/favorites.html"}).when("/login",{templateUrl:"templates/login.html"}).when("/register",{templateUrl:"templates/register.html"}).otherwise({redirectTo:"/"})}]),app.controller("NavbarCtrl",["$scope","$location","authFactory",function(a,b,c){a.isActive=function(a){return a===b.path()},a.logout=function(){c.logout().success(function(){b.path("/login")})},a.isLoggedIn=function(){return c.isAuthenticated()}}]),app.controller("SidebarCtrl",["$scope","$location","authFactory",function(a,b){a.isActive=function(a){return a===b.path()}}]),app.controller("UserCtrl",["$http","$scope","ServerUrl","$location","$window",function(a,b,c,d,e){b.registerUser=function(b){var f={user:b};a.post(c+"users",f).success(function(b){e.sessionStorage.setItem("OnMyPlate.user",b.token),a.defaults.headers.common.Authorization="Token token="+e.sessionStorage.getItem("OnMyPlate.user"),d.path("/home")}).error(function(){d.path("/register")})}}]),app.controller("LoginCtrl",["$scope","$location","authFactory",function(a,b,c){a.login=function(a){c.login(a).success(function(){b.path("/")})}}]),app.controller("AddCtrl",["$scope","$http","ServerUrl","$location","$q","imageFactory",function(a,b,c,d,e,f){a.ratingVals=[1,2,3,4,5],a.addReview=function(a,b,c){g(c,a,b)};var g=function(a,f,g){var i={food:a};b.post(c+"foods",i).success(function(){e.all(h(f,g)).then(function(){d.path("/profile"),console.log("post created!")})})},h=function(a,d){var g={post:a};b.post(c+"posts",g).success(function(){e.all(f.signKey(d)).then(function(){console.log("nice!")})})}}]),app.controller("ProfileCtrl",["$http","ServerUrl","$scope","userFactory","$q","$window","dataFactory",function(a,b,c,d,e,f,g){var h=[];g.fetchFoods().then(function(a){c.foods=a.data.foods}),g.fetchUsers().then(function(a){e.all(d.createUsersArray(a.data.users,h)).then(function(){c.currentUser=d.defineCurrentUser(h)})})}]),app.controller("FoodCtrl",function(){}),app.factory("authFactory",["$http","$window","ServerUrl","$location",function(a,b,c,d){var e=function(e){return a.post(c+"login",e).success(function(c){b.sessionStorage.setItem("OnMyPlate.user",c.token),a.defaults.headers.common.Authorization="Token token="+b.sessionStorage.getItem("OnMyPlate.user")}).error(function(){d.path("/login")})},f=function(){return a.get(c+"logout").success(function(){b.sessionStorage.removeItem("OnMyPlate.user")})},g=function(){return!!b.sessionStorage.getItem("OnMyPlate.user")};return{login:e,logout:f,isAuthenticated:g}}]),app.factory("userFactory",["$window","$http","ServerUrl",function(a){var b=function(a,b){for(var c=0;c<a.length;c++)b.push(a[c]);return b},c=function(a){for(var b=d(),c=0;c<a.length;c++)if(a[c].token===b)return a[c]},d=function(){return a.sessionStorage.getItem("OnMyPlate.user")};return{createUsersArray:b,defineCurrentUser:c}}]),app.factory("imageFactory",["$http","ServerUrl","$q","$location",function(a,b,c){var d,e=function(e){return a.get(b+"amazon/sign_key").success(function(a){d=a;var b={food_image:{image_url:"https://ompimages.s3.amazonaws.com/"+d.key}};c.all(g(b)).then(function(){f(e,d)})})},f=function(b,c){var d=new FormData;d.append("key",c.key),d.append("AWSAccessKeyId",c.access_key),d.append("policy",c.policy),d.append("acl","public-read"),d.append("signature",c.signature),d.append("Content-Type","image/jpeg"),d.append("file",b),a.post("https://ompimages.s3.amazonaws.com/",d,{transformRequest:angular.identity,headers:{"Content-Type":void 0,Authorization:""}}).success(function(){console.log("eureka!")}).error(function(){console.log("fuck you")})},g=function(c){var d=[];d.push(a.post(b+"food_images",c))};return{signKey:e}}]),app.factory("dataFactory",["$http","ServerUrl",function(a,b){var c=function(){return a.get(b+"foods.json").success(function(a){return a.foods})},d=function(){return a.get(b+"users.json").success(function(a){return a.users})};return{fetchFoods:c,fetchUsers:d}}]),app.directive("fileread",function(){return{scope:{fileread:"="},link:function(a,b){b.bind("change",function(b){a.$apply(function(){a.fileread=b.target.files[0]})})}}});